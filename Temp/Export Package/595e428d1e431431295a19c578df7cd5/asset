using UnityEngine;
using System.Collections;
using System.Collections.Generic;
[RequireComponent(typeof(MeshFilter), typeof(MeshRenderer))]

public class RaycastShadows : MonoBehaviour {
public GameObject meshHolder;
public GameObject player;
public bool takeVectorPoint = true;
public bool makeAVectorList;
public float numberOfRays;
int vectorPointNumber = 0;
public float angle;
public List<Vector3> vectorList;
public List<Vector3> vectorList2;
Vector3 newVertices;	
public Vector3 prevVector;
public Vector3 _playerPos;
Vector3 tmp;
Vector3 tmp2;
RaycastHit hit;

	void Start () 
	{			
		DetectObjects();	
	}	

	void Update ()
	{	
		DetectObjects();
	}	
	
	void DetectObjects()		
		{	
		vectorList.Clear();
		vectorList.Add (meshHolder.transform.InverseTransformPoint(transform.position));
		Debug.Log (vectorList[0]);
		angle = 0;
		for (int i=0; i<numberOfRays; i++)
			{
			angle += 2*Mathf.PI/numberOfRays;
			Vector3 direction = new Vector3(Mathf.Cos(angle), Mathf.Sin(angle), 0);			
				if (Physics.Raycast(transform.position, direction, out hit))
			      	{						
						tmp = meshHolder.transform.InverseTransformPoint(hit.point);
						vectorList.Add (new Vector3(tmp.x,tmp.y,0));	
					}		
			
			}		
		DrawMesh();	
	}	
	
	
	void DrawMesh()
	{
		Mesh mesh = meshHolder.GetComponent<MeshFilter>().mesh;
		mesh.Clear();		
		Vector3[] vertices = mesh.vertices;
		Vector2[] uv = mesh.uv;
		vertices = new Vector3 [vectorList.Count+1];
		uv = new Vector2 [vectorList.Count+1];
		int[] triangles = mesh.triangles;
		triangles = new int [vectorList.Count*3];
		vertices[0] = vectorList[0];
		for(int v = 1, t = 1; v < vectorList.Count; v++, t += 3)
		{
			vertices[v] = vectorList[v];
			triangles[t] = v;
			triangles[t + 1] = v + 1;
		}
//		vertices[0] = new Vector3(player.transform.position.x,player.transform.position.y,0);
		vertices[vectorList.Count] = meshHolder.transform.InverseTransformPoint(transform.position);
//		meshholder.transform.InverseTransformPoint(transform.position)
		triangles[triangles.Length - 1] = 1;
		mesh.vertices = vertices;
		for (int i=0; i<vectorList.Count; i++)
			{
			Debug.Log (""+i+ ""+vertices[i]+"");			
			}
			Debug.Log (""+vectorList.Count+ ""+vertices[vectorList.Count]+"");
		mesh.uv = uv;		
		mesh.triangles = triangles;
	}
}
